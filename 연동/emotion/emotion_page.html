<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ì˜ ê°ì •</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'emotion/css/emotion_page.css' %}">
    <style>
        @import url("{% static 'css/fonts.css' %}");
    </style>
</head>
<body>
    {% load static %}
    {% load date_kr %}
    <div id="wrap">
        <main>
            <div class="topbar">
                <button type="button" class="back_btn" onclick="window.history.back()">
                    <img src="{% static 'img/arrow_back.svg' %}" alt="ë’¤ë¡œê°€ê¸°">
                </button>           
                <span class="comment_login">ì˜¤ëŠ˜ì˜ ê°ì •</span> 
            </div>
            
            <div class="calendar">
                <div class="week" id="week-calendar">
                    {% for date in dates %}
                    <div class="day {% if date == selected_date %}active{% endif %}" data-date="{{ date|date:'Y-m-d' }}">
                        <a href="?date={{ date|date:'Y-m-d' }}">
                                <div>{{ date|date_kr }}</div>
                                <div>{{ date|date:'j' }}</div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>            

            <div class="details">
                <div class="date-info">
                    <div class="full-date" id="full-date">{{ selected_date|date:'Yë…„ nì›” jì¼' }}</div>
                    <div class="day-of-week-container">
                        <div class="day-of-week" id="day-of-week"></div>
                        <!--<button class="plus-button" id="plus-button"></button>-->
                        <a href="{% url 'emotion_create' %}" class="plus-button" id="plus-button"></a>
                    </div>
            </div>

            <div class="mood-list">
            {% if emotions %}
                {% for emotion in emotions %}
                <div class="mood-item">
                    <span class="emoji">
                        {% if emotion.emotion == 'happy' %}
                            ğŸ˜Š
                        {% elif emotion.emotion == 'neutral' %}
                            ğŸ˜
                        {% elif emotion.emotion == 'sad' %}
                            ğŸ˜¢
                        {% elif emotion.emotion == 'angry' %}
                            ğŸ˜ 
                        {% endif %}
                    </span>

                    <div class="mood-details">
                        <div class="mood-title-time">
                            <div class="mood-title">{{ emotion.get_emotion_display }}</div>
                            <div class="mood-time">{{ emotion.time|time:"H:i" }}</div>
                        </div>
                        <div class="mood-reason" id ="mood-reason">{{ emotion.description }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="comment-section">
                <div class="comment-list">
                        {% if emotion.protector_comment %}
                            {% for protector in emotion.user.userprofile.protectors %}
                            <div class="comment-item">
                                {% if protector.profile_image %}
                                    <img src="{{ protector.profile_image.url }}" alt="Protector Profile Image" class="comment-emoji">
                                {% else %}
                                    <img src="{% static 'default_profile.png' %}" alt="Default Profile Image" class="comment-emoji">
                                {% endif %}

                                <div class="comment-details">
                                    <div class="comment-title-time">
                                        <div class="comment-title">{{ protector.user.username }}</div>
                                        <div class="comment-time">ì‹œê°„ ëˆ„ë½ë¨</div> <!--ë³´í˜¸ìê°€ ëŒ“ê¸€ì„ ë‹¨ ì‹œê°„ì´ ëˆ„ë½ëœë“¯?-->
                                    </div>
                                    <div class="comment-reason" id="comment-reason">{{ emotion.protector_comment }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                </div>
            </div>
                {% endfor %}
            {% else %}
                <div class="mood-list2">
                    <div class="mood-item2">
                        <div class="emoji2">ğŸ«¥</div>
                        <div class="mood-details2">
                            <div class="mood-title-time2">
                                <div class="mood-title2">ì•„ì§ ê¸°ë¡ëœ ê°ì •ì´ ì—†ì–´ìš”</div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>

<!--modal-->
<div class="modal-backdrop"></div>
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">ì·¨ì†Œ</span>
            <div class="modal-title">ì˜¤ëŠ˜ì˜ ê°ì • ê¸°ë¡í•˜ê¸°</div>
        </div>

        <form method="post">
            {% csrf_token %}
            <div class="recorded-emotion">
                <div class="span1">ğŸ˜Š ê¸°ë¡ëœ ì˜¤ëŠ˜ì˜ ê°ì •</div>
                <div class="span2" id="recorded-emotion-status">ì—†ìŒ</div>
            </div>
            
            <div class="record-info">ì˜¤ëŠ˜ì˜ ê°ì •ì€ í•˜ë£¨ì— í•œ ê°œ ê¸°ë¡í•  ìˆ˜ ìˆì–´ìš”</div>


            <label for="emotion" class="emotion-title">ê°ì •</label>

            <div class="emotion-cards">
                <div class="emotion-card" onclick="selectEmotion(this)">
                    <input type="radio" id="happy" name="emotion" value="happy">
                    <label for="happy">
                        <div class="emoji">ğŸ˜Š</div>
                        í–‰ë³µ
                    </label>
                </div>
                <div class="emotion-card" onclick="selectEmotion(this)">
                    <input type="radio" id="neutral" name="emotion" value="neutral">
                    <label for="neutral">
                        <div class="emoji">ğŸ˜</div>
                        í‰ë²”
                    </label>
                </div>
                <div class="emotion-card" onclick="selectEmotion(this)">
                    <input type="radio" id="sad" name="emotion" value="sad">
                    <label for="sad">
                        <div class="emoji">ğŸ˜¢</div>
                        ìŠ¬í””
                    </label>
                </div>
                <div class="emotion-card" onclick="selectEmotion(this)">
                    <input type="radio" id="angry" name="emotion" value="angry">
                    <label for="angry">
                        <div class="emoji">ğŸ˜ </div>
                        ë¶„ë…¸
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="hour" class="hour">ê°ì •ì„ ëŠë‚€ ì‹œê°„</label>
                <input type="hidden" id="time-field" name="time" value="{{ form.time.value }}">
                <div class="time-inputs">
                    <input type="text" id="hour" maxlength="2" placeholder="00" class="time-input" inputmode="numeric" pattern="[0-9]*"> 
                    <div>ì‹œ</div>
                    <input type="text" id="minute" maxlength="2" placeholder="00" class="time-input" inputmode="numeric" pattern="[0-9]*"> 
                    <div>ë¶„</div>
                </div>
                <div id="error-message" class="error-message hidden">ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”</div>
            </div>
            
                <!--<div class="description-field">
                    <label for="description">ê°ì •ì„ ëŠë‚€ ì´ìœ </label>
                    {{ form.description }}
                </div> -->

            <div class="form-group">
                <label for="reason">ê°ì •ì„ ëŠë‚€ ì´ìœ </label>
                <input type="text" id="reason" name="description" placeholder="ê°ì •ì„ ëŠë‚€ ì´ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”">
            </div>

            <button type="submit" id="submit-button"  class="submit-button" disabled>ê¸°ë¡</button>
        </form>
    </div>
</div>
<!--
<script src="{% static 'emotion/js/emotion_page.js' %}"></script>
ì—°ê²° ì•ˆë˜ëŠ”ë””?-->
<script>
    function selectEmotion(card) {
        var cards = document.getElementsByClassName('emotion-card');
        for (var i = 0; i < cards.length; i++) {
            cards[i].classList.remove('selected');
        }
        card.classList.add('selected');
    }
    
    function truncateText(element, maxLength) {
        let text = element.textContent;
        if (text.length > maxLength) {
            element.textContent = text.slice(0, maxLength) + '...';
        }
    }
    document.querySelectorAll('.mood-reason').forEach(function(element) {
        truncateText(element, 19);
    });
    
    document.querySelectorAll('.comment-reason').forEach(function(element) {
        truncateText(element, 30);
    });
    
    document.addEventListener("DOMContentLoaded", function() {
        const plusButton = document.getElementById('plus-button');
        const modalBackdrop = document.querySelector('.modal-backdrop');
        const modal = document.getElementById('modal');
        const closeModalButton = document.querySelector('.close');
        const submitButton = document.getElementById('submit-button');
        const hourInput = document.getElementById('hour');
        const minuteInput = document.getElementById('minute');
        const reasonInput = document.getElementById('reason');
        const errorMessage = document.getElementById('error-message');
        const emotionButtons = document.querySelectorAll('.emotion-card');
        const recordedEmotionStatus = document.getElementById('recorded-emotion-status');
        const formTimeInput = document.getElementById('time-field'); // Django form í•„ë“œë¥¼ ì„ íƒ
        const commentReason = document.querySelectorAll('.comment-reason');
        const moodReason = document.querySelectorAll('.mood-reason');
        const selectedDateKr = "{{ selected_date|date:'Yë…„ nì›” jì¼' }}";
        const daysOfWeek = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
        const dayOfWeekElement = document.getElementById('day-of-week');
        const activeDay = document.querySelector('.day.active');
    
        let selectedEmotionText = null;
    
        function formatDateToKR(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }
    
        function updateDayOfWeek(dateString) {
            const date = new Date(dateString);
            const dayOfWeek = daysOfWeek[date.getDay()];
            if (dayOfWeekElement) {
                dayOfWeekElement.textContent = dayOfWeek;
            }
        }
    
        if (activeDay) {
            const selectedDate = activeDay.getAttribute('data-date');
            updateDayOfWeek(selectedDate);
        }
    
        function updatePlusButtonState() {
            const todayKR = formatDateToKR(new Date());
            if (selectedDateKr !== todayKR) {
                plusButton.classList.add('disabled');
            } else {
                plusButton.classList.remove('disabled');
            }
        }
    
        updatePlusButtonState();
    
        if (dayOfWeekElement) {
            const date = new Date();
            const dayOfWeek = daysOfWeek[date.getDay()];
            dayOfWeekElement.textContent = dayOfWeek;
        }
    
        /** ë‹¤ì´ì–¼ë¡œê·¸ ì‚¬ìš© ì‹œ ì£¼ì„
        plusButton.addEventListener('click', function() {
            modal.classList.add('show');
            modalBackdrop.classList.add('show');
        });
        */
        closeModalButton.addEventListener('click', function() {
            modal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });
    
        modalBackdrop.addEventListener('click', function() {
            modal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });
    
        function validateTime(hour, minute) {
            const hourValue = parseInt(hour, 10);
            const minuteValue = parseInt(minute, 10);
            const isValidHour = !isNaN(hourValue) && hourValue >= 0 && hourValue < 24;
            const isValidMinute = !isNaN(minuteValue) && minuteValue >= 0 && minuteValue < 60;
            return isValidHour && isValidMinute;
        }
    
        function checkTimeInput() {
            const hour = hourInput.value;
            const minute = minuteInput.value;
            if (validateTime(hour, minute)) {
                errorMessage.classList.add('hidden');
            } else {
                errorMessage.classList.remove('hidden');
            }
        }
    
        function isFormValid() {
            const hour = hourInput.value;
            const minute = minuteInput.value;
            const reason = reasonInput.value.trim();
            return selectedEmotionText && validateTime(hour, minute) && reason !== '';
        }
    
        function updateSubmitButtonState() {
            if (isFormValid()) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }
    
        function updateTimeField() {
            const hour = hourInput.value.padStart(2, '0');
            const minute = minuteInput.value.padStart(2, '0');
            const timeString = `${hour}:${minute}`;
    
            if (formTimeInput) { 
                formTimeInput.value = timeString;
                console.log('Updated time:', timeString);
            } else {
                console.error('formTimeInput element not found');
            }
        }
    
        hourInput.addEventListener('input', function() {
            checkTimeInput();
            updateTimeField();
            updateSubmitButtonState();
        });
    
        minuteInput.addEventListener('input', function() {
            checkTimeInput();
            updateTimeField();
            updateSubmitButtonState();
        });
    
        reasonInput.addEventListener('input', updateSubmitButtonState);
    
        emotionButtons.forEach(button => {
            button.addEventListener('click', function() {
                selectedEmotionText = this.querySelector('.emoji').textContent.trim();
                emotionButtons.forEach(btn => btn.classList.remove('selected')); 
                this.classList.add('selected'); 
                updateSubmitButtonState();
            });
        });
    
        submitButton.addEventListener('click', function(event) {
            const hour = hourInput.value;
            const minute = minuteInput.value;
            if (!validateTime(hour, minute)) {
                event.preventDefault();
                errorMessage.classList.remove('hidden');
            } else {
                recordedEmotionStatus.textContent = selectedEmotionText || 'ì—†ìŒ';
                modal.classList.remove('show');
                modalBackdrop.classList.remove('show');
                submitButton.disabled = true;
                plusButton.disabled = true; 
            }
        });
    });
</script>
</body>
</html>
